# @bashcat 天氣與地震查詢功能使用說明

## 📋 功能概覽

已成功為您的 Meshtastic 系統添加了智能天氣與地震查詢功能。當用戶在訊息中使用 `@bashcat` 標記時，系統會自動檢測查詢內容並調用相應的 CWA API 獲取實時資料，然後通過 LLM 生成智能回應。

## 🌤️ 天氣查詢功能

### 支援的城市
系統支援台灣所有縣市的天氣查詢，包括：
- **直轄市**: 臺北市、新北市、桃園市、臺中市、臺南市、高雄市
- **省轄市**: 基隆市、新竹市、嘉義市
- **縣**: 宜蘭縣、新竹縣、苗栗縣、彰化縣、南投縣、雲林縣、嘉義縣、屏東縣、臺東縣、花蓮縣、澎湖縣、金門縣、連江縣

### 支援的地名格式
- **完整縣市名**: 臺北市、高雄市、花蓮縣
- **簡化地名**: 台北、高雄、花蓮
- **繁簡體混用**: 台北、臺北都可識別

### 使用方式
```
@bashcat 台北天氣如何？
@bashcat 高雄今天會下雨嗎？
@bashcat 花蓮的天氣預報
@bashcat 臺中市天氣狀況
```

### 提供的天氣資訊
- 🌤️ **天氣狀況**: 晴天、多雲、雨天等
- 🌡️ **溫度範圍**: 當日最低/最高溫度
- ☔ **降雨機率**: 百分比顯示

## 🌏 地震查詢功能

### 使用方式
```
@bashcat 最近有地震嗎？
@bashcat 今天的地震情況
@bashcat 地震資訊
```

### 提供的地震資訊
- ⏰ **發生時間**: 精確到分鐘
- 📍 **震央位置**: 詳細地理位置描述
- 📊 **地震規模**: 芮氏規模數值
- 📏 **震源深度**: 公里為單位
- 🌊 **最大震度**: 台灣震度分級
- 📝 **詳細說明**: 官方地震報告內容

## 🔧 技術特色

### 🎯 智能識別
- **關鍵詞檢測**: 自動識別「天氣」和「地震」關鍵詞
- **地名解析**: 智能匹配用戶輸入的地名到標準縣市名稱
- **優先級匹配**: 優先匹配較長的地名（避免誤判）

### 📡 即時資料
- **官方資料源**: 直接調用中央氣象署開放資料 API
- **即時更新**: 提供最新的天氣預報和地震資訊
- **資料驗證**: 完整的錯誤處理和資料驗證機制

### 🤖 LLM 增強
- **上下文豐富**: 將 CWA 資料注入 LLM prompt
- **自然回應**: 生成人性化的回答
- **長度控制**: 回應限制在 66 字以內（適合 Meshtastic 傳輸）

## 📊 處理流程

```
用戶輸入 -> 檢測@bashcat -> 關鍵詞分析 -> CWA API調用 -> 資料處理 -> LLM生成 -> 發送回應
```

### 詳細步驟
1. **訊息接收**: 系統接收包含 `@bashcat` 的訊息
2. **內容提取**: 提取 `@bashcat` 後的實際查詢內容
3. **關鍵詞檢測**: 檢查是否包含「天氣」或「地震」關鍵詞
4. **資料獲取**: 
   - 天氣查詢: 解析地名 → 調用 `get_city_weather()` 
   - 地震查詢: 調用 `get_latest_earthquake()`
5. **Prompt 增強**: 將 CWA 資料整合到 LLM prompt 中
6. **回應生成**: LLM 生成自然語言回應
7. **訊息發送**: 將回應發送到原始頻道

## 🛠️ 配置文件

### 城市映射表
```python
CITY_TO_FULL_NAME = {
    '台北': '臺北市',
    '高雄': '高雄市',
    '花蓮': '花蓮縣',
    # ... 完整映射表
}
```

### API 客戶端
```python
from cwa_client import CWAClient
cwa_client = CWAClient()  # 自動從 .env 讀取 API 金鑰
```

## 📝 使用範例

### 天氣查詢範例
```
用戶: @bashcat 台北今天天氣如何？

系統處理:
1. 檢測到天氣查詢
2. 識別地名: 台北 -> 臺北市
3. 調用CWA API獲取臺北市天氣
4. 資料: 晴時多雲, 27-32°C, 降雨機率20%
5. LLM生成: 台北今天天氣不錯！晴時多雲，溫度27-32度，降雨機率只有20%，適合外出活動。

回應: 台北今天天氣不錯！晴時多雲，溫度27-32度，降雨機率只有20%，適合外出活動。
```

### 地震查詢範例
```
用戶: @bashcat 最近有地震嗎？

系統處理:
1. 檢測到地震查詢
2. 調用CWA API獲取最新地震資訊
3. 資料: 2025-06-24 02:00:56, 花蓮縣萬榮鄉, M4.9, 深度13km, 最大震度4級
4. LLM生成: 最近一次地震發生在今天凌晨2點，花蓮縣萬榮鄉發生規模4.9地震，深度13公里，最大震度4級。

回應: 最近一次地震發生在今天凌晨2點，花蓮縣萬榮鄉發生規模4.9地震，深度13公里，最大震度4級。
```

## 🔍 測試方法

使用提供的測試腳本驗證功能：
```bash
python3 test_bashcat_weather_earthquake.py
```

測試內容包括：
- ✅ 城市映射功能
- ✅ 關鍵詞檢測邏輯
- ✅ 天氣查詢 API 調用
- ✅ 地震查詢 API 調用

## 📋 注意事項

1. **網路依賴**: 需要穩定的網路連線來訪問 CWA API
2. **API 限制**: 請注意 CWA API 的使用限制和配額
3. **回應長度**: LLM 回應限制在 66 字以內
4. **錯誤處理**: 包含完整的錯誤處理，API 失敗時會有相應提示

## 🎯 未來擴展

可考慮添加的功能：
- 🌊 **海象資訊**: 潮汐、海況查詢
- ⚠️ **警特報**: 天氣警報、颱風資訊
- 📈 **歷史資料**: 過往天氣、地震記錄
- 🗓️ **多日預報**: 一週天氣預報
